name: Win Server with SakuraFrp

on:
  workflow_dispatch:
    inputs:
      sakurafrp_token:
        description: 'SakuraFrp 认证令牌'
        required: true
        default: 'wadr25y8xv6h4ek361eoitlfsn7ow2nn'  # 不要在这里填写实际令牌，保持为空让用户输入
      node_id:
        description: 'SakuraFrp 节点 ID'
        required: true
        default: '17573313'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: 启用 RDP 服务
        run: |
          # 启用远程桌面
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # 显示 RDP 服务状态
          Get-Service TermService

      - name: 下载并配置 SakuraFrp 客户端
        env:
          SAKURAFRP_TOKEN: ${{ github.event.inputs.sakurafrp_token }}
          NODE_ID: ${{ github.event.inputs.node_id }}
        run: |
          # 下载 Windows 版 frp 客户端
          Invoke-WebRequest -Uri "https://nya.globalslb.net/natfrp/client/frpc/0.51.0-sakura-12.3/frpc_windows_amd64.exe" -OutFile "frpc.exe"

          frpc -f wadr25y8xv6h4ek361eoitlfsn7ow2nn:17573313
          
          # 等待启动并显示日志
          Start-Sleep -Seconds 10
          Get-Content -Path "frpc.log" -ErrorAction SilentlyContinue

      - name: 保持工作流运行
        run: |
          Write-Host "RDP 服务已启用，frp 客户端已启动"
          Write-Host "工作流将持续运行 60 分钟"
          
          # 每30秒检查一次frp进程状态
          $endTime = (Get-Date).AddMinutes(55)
          while ((Get-Date) -lt $endTime) {
            $frpProcess = Get-Process "frpc" -ErrorAction SilentlyContinue
            if (-not $frpProcess) {
              Write-Error "frp 客户端已停止，重新启动..."
              Start-Process -FilePath "start_frp.bat" -NoNewWindow
            }
            Start-Sleep -Seconds 30
          }
    
