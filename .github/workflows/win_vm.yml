name: Win Server with SakuraFrp

# è§¦å‘æ–¹å¼ï¼šä»…æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…è‡ªåŠ¨æ¶ˆè€—èµ„æº
on:
  workflow_dispatch:
    inputs:
      zerotier_fixed_ip:
        description: 'ZeroTier å›ºå®šIPï¼ˆå¦‚192.168.192.100ï¼Œéœ€ä¸ç½‘ç»œç½‘æ®µåŒ¹é…ï¼‰'
        required: true
        default: '192.168.192.100'  # ç¤ºä¾‹å›ºå®šIPï¼Œéœ€æ ¹æ®ä½ çš„ZeroTierç½‘ç»œä¿®æ”¹

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 300  # åŒ¹é…åç»­300åˆ†é’Ÿè¿è¡Œé€»è¾‘ï¼Œé¿å…æå‰ç»ˆæ­¢
    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç ï¼ˆæ— æœ¬åœ°æ–‡ä»¶éœ€æ±‚å¯åˆ é™¤ï¼‰
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        continue-on-error: true  # æ— ä»£ç ä»“åº“æ—¶ä¸ç»ˆæ­¢å·¥ä½œæµ

      # 2. å¯ç”¨RDPæœåŠ¡ä¸é˜²ç«å¢™é…ç½®
      - name: Enable RDP Service
        shell: pwsh
        run: |
          # å…è®¸è¿œç¨‹æ¡Œé¢è¿æ¥
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          # æ”¾è¡ŒRDPé˜²ç«å¢™è§„åˆ™
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # éªŒè¯RDPæœåŠ¡çŠ¶æ€
          $rdpService = Get-Service -Name TermService -ErrorAction Stop
          Write-Host "âœ… RDPæœåŠ¡å½“å‰çŠ¶æ€: $($rdpService.Status)"
          if ($rdpService.Status -ne "Running") {
            Start-Service -Name TermService
            Write-Host "âœ… RDPæœåŠ¡å·²å¯åŠ¨"
          }

      # 3. åˆ›å»ºRDPç™»å½•ç”¨æˆ·ï¼ˆå«ç®¡ç†å‘˜æƒé™ï¼‰
      - name: Create RDP User & Set Password
        shell: pwsh
        run: |
          # é…ç½®ç”¨æˆ·ä¿¡æ¯ï¼ˆå»ºè®®å®šæœŸæ›´æ–°å¯†ç ï¼‰
          $username = "GithubRunnerUser"
          $password = ConvertTo-SecureString "LDld@123000!" -AsPlainText -Force  # å¼ºå¯†ç è§„èŒƒ
          
          # åˆ›å»ºæœ¬åœ°ç”¨æˆ·å¹¶é…ç½®æƒé™
          New-LocalUser -Name $username -Password $password -FullName "GitHub Actions RDP User" -AccountNeverExpires -ErrorAction Stop
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username  # æ ¸å¿ƒRDPæƒé™
          Add-LocalGroupMember -Group "Administrators" -Member $username  # ç®¡ç†å‘˜æƒé™ï¼ˆæŒ‰éœ€ä¿ç•™ï¼‰
          
          # å¯ç”¨ç½‘ç»œçº§åˆ«èº«ä»½éªŒè¯ï¼ˆå¢å¼ºå®‰å…¨æ€§ï¼‰
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          
          # è¾“å‡ºç™»å½•ä¿¡æ¯ï¼ˆä»…å·¥ä½œæµæ—¥å¿—å¯è§ï¼‰
          Write-Host "`n==================== RDP ç™»å½•ä¿¡æ¯ ===================="
          Write-Host "ğŸ”‘ ç”¨æˆ·å: $username"
          Write-Host "ğŸ”‘ å¯†ç : $($password | ConvertFrom-SecureString -AsPlainText)"
          Write-Host "=======================================================`n"

      # 5. å®‰è£…ZeroTieræœåŠ¡
      - name: Install ZeroTier
        shell: pwsh
        run: |
          # ä¸‹è½½ZeroTierå®‰è£…åŒ…ï¼ˆå®˜æ–¹é“¾æ¥ï¼‰
          $ztUrl = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          Invoke-WebRequest -Uri $ztUrl -OutFile "ZeroTierOne.msi" -UseBasicParsing -TimeoutSec 30
          
          # é™é»˜å®‰è£…ï¼ˆæ— ç•Œé¢ï¼‰
          msiexec /i ZeroTierOne.msi /quiet /norestart /qn
          Start-Sleep -Seconds 15  # ç­‰å¾…å®‰è£…ä¸æœåŠ¡æ³¨å†Œ
          
          # å¯åŠ¨ZeroTieræœåŠ¡
          $ztService = Get-Service -Name zerotier-one -ErrorAction Stop
          if ($ztService.Status -ne "Running") {
            Start-Service -Name zerotier-one
            Start-Sleep -Seconds 5
          }
          Write-Host "âœ… ZeroTieræœåŠ¡çŠ¶æ€: $($ztService.Status)"

      # 6. åŠ å…¥ZeroTierç½‘ç»œå¹¶è·å–è®¾å¤‡ID
      - name: Join ZeroTier Network & Get Device ID
        id: join_zt_network  # å®šä¹‰IDä¾›åç»­å¼•ç”¨
        shell: pwsh
        env:
          ZT_NETWORK_ID: "b6079f73c6b1c2e3"  # ä½ çš„ZeroTierç½‘ç»œIDï¼ˆä»æ§åˆ¶å°è·å–ï¼‰
        run: |
          # åŠ å…¥æŒ‡å®šç½‘ç»œ
          zerotier-cli join $env:ZT_NETWORK_ID
          Start-Sleep -Seconds 8  # ç­‰å¾…ç½‘ç»œæ¡æ‰‹
          
          # æå–è®¾å¤‡IDï¼ˆ10-16ä½å­—æ¯æ•°å­—ï¼‰
          $ztInfo = zerotier-cli info
          if ($ztInfo -match "(\w{10,16})") {
            $deviceId = $matches[1]
            Write-Host "âœ… ZeroTierè®¾å¤‡ID: $deviceId"
            # è¾“å‡ºåˆ°å·¥ä½œæµå˜é‡
            echo "DEVICE_ID=$deviceId" | Out-File $env:GITHUB_OUTPUT -Append
          } else {
            Write-Error "âŒ æ— æ³•è·å–ZeroTierè®¾å¤‡IDï¼ŒåŸå§‹ä¿¡æ¯: $ztInfo"
            exit 1
          }

      # 7. æˆæƒZeroTierè®¾å¤‡å¹¶åˆ†é…å›ºå®šIP
      - name: Authorize ZeroTier & Assign Fixed IP
        shell: pwsh
        env:
          ZT_NETWORK_ID: "b6079f73c6b1c2e3"  # ä¸æ­¥éª¤6ä¸€è‡´çš„ç½‘ç»œID
          ZT_API_TOKEN: "fy8SpZm8aDETYczPl4WqG0vQ0kLaQCyJ"  # ä½ çš„ZeroTier APIä»¤ç‰Œ
          ZT_FIXED_IP: ${{ github.event.inputs.zerotier_fixed_ip }}  # ä»æ‰‹åŠ¨è¾“å…¥è·å–å›ºå®šIP
          ZT_DEVICE_ID: ${{ steps.join_zt_network.outputs.DEVICE_ID }}
        run: |
          # æ„é€ APIè¯·æ±‚ï¼ˆæˆæƒ+IPåˆ†é…ï¼‰
          $apiUri = "https://my.zerotier.com/api/network/$env:ZT_NETWORK_ID/member/$env:ZT_DEVICE_ID"
          $headers = @{
            "Authorization" = "token $env:ZT_API_TOKEN"
            "Content-Type"  = "application/json"
          }
          $body = @{
            config = @{
              authorized    = $true  # è‡ªåŠ¨æˆæƒ
              ipAssignments = @($env:ZT_FIXED_IP)  # åˆ†é…å›ºå®šIP
              activeBridge  = $false  # ç¦ç”¨æ¡¥æ¥é˜²å†²çª
            }
          } | ConvertTo-Json
          
          # å‘é€è¯·æ±‚å¹¶éªŒè¯
          try {
            $response = Invoke-RestMethod -Uri $apiUri -Headers $headers -Method Post -Body $body -ErrorAction Stop
            Write-Host "âœ… ZeroTieræˆæƒæˆåŠŸï¼Œå·²åˆ†é…å›ºå®šIP: $env:ZT_FIXED_IP"
          } catch {
            Write-Error "âŒ ZeroTieræˆæƒå¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…: $($_.Exception.Response.Content)"
            exit 1
          }
          Start-Sleep -Seconds 12  # ç­‰å¾…IPç”Ÿæ•ˆ

      # 8. éªŒè¯ZeroTier IPé…ç½®
      - name: Verify ZeroTier IP
        shell: pwsh
        run: |
          # è·å–ZeroTierç½‘å¡
          $ztInterface = Get-NetAdapter | Where-Object { $_.InterfaceDescription -match "ZeroTier" } | Select-Object -First 1
          if ($ztInterface) {
            Write-Host "`n==================== ZeroTier ç½‘ç»œä¿¡æ¯ ===================="
            Write-Host "ğŸ”Œ æ¥å£åç§°: $($ztInterface.InterfaceAlias)"
            Write-Host "ğŸ”Œ æ¥å£çŠ¶æ€: $($ztInterface.Status)"
            Write-Host "ğŸ”Œ IPv4åœ°å€: "
            Get-NetIPAddress -InterfaceAlias $ztInterface.InterfaceAlias -AddressFamily IPv4 | Select-Object IPAddress, PrefixLength
            Write-Host "=======================================================`n"
          } else {
            Write-Error "âŒ æœªæ‰¾åˆ°ZeroTierç½‘å¡ï¼Œå¯èƒ½æœªæˆåŠŸåŠ å…¥ç½‘ç»œ"
            exit 1
          }

      # 9. ä¿æŒå·¥ä½œæµè¿è¡Œï¼ˆæ ¸å¿ƒï¼šé˜²æ­¢ä¼šè¯æ–­å¼€ï¼‰
      - name: Keep Workflow Running
        shell: pwsh
        run: |
          
          # ç›‘æ§Frpè¿›ç¨‹ï¼ˆæ„å¤–åœæ­¢æ—¶é‡å¯ï¼‰
          $endTime = (Get-Date).AddMinutes(300)
          while ((Get-Date) -lt $endTime) {
            Start-Sleep -Seconds 30  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
          }
          Write-Host "`nâ° å·¥ä½œæµè¿è¡Œæ—¶é—´å·²ç»“æŸï¼Œå¼€å§‹æ¸…ç†èµ„æº"

      # 10. æ¸…ç†ZeroTierèµ„æºï¼ˆæ— è®ºæˆåŠŸ/å¤±è´¥å‡æ‰§è¡Œï¼‰
      - name: Cleanup ZeroTier
        shell: pwsh
        if: always()
        env:
          ZT_NETWORK_ID: "b6079f73c6b1c2e3"
          ZT_API_TOKEN: "fy8SpZm8aDETYczPl4WqG0vQ0kLaQCyJ"
          ZT_DEVICE_ID: ${{ steps.join_zt_network.outputs.DEVICE_ID }}
        run: |
          # 1. ç¦»å¼€ZeroTierç½‘ç»œ
          Write-Host "`nğŸ”§ å¼€å§‹æ¸…ç†ZeroTierèµ„æº..."
          zerotier-cli leave $env:ZT_NETWORK_ID
          Start-Sleep -Seconds 5
          
          # 2. é‡Šæ”¾IPåœ°å€
          $ztInterface = Get-NetAdapter | Where-Object { $_.InterfaceDescription -match "ZeroTier" } | Select-Object -First 1
          if ($ztInterface) {
            Remove-NetIPAddress -InterfaceAlias $ztInterface.InterfaceAlias -AddressFamily IPv4 -Confirm:$false -ErrorAction SilentlyContinue
            Write-Host "âœ… ZeroTier IPå·²é‡Šæ”¾"
          }
          
          # 3. å–æ¶ˆè®¾å¤‡æˆæƒï¼ˆé¿å…æ®‹ç•™ï¼‰
          if (-not [string]::IsNullOrEmpty($env:ZT_API_TOKEN)) {
            $apiUri = "https://my.zerotier.com/api/network/$env:ZT_NETWORK_ID/member/$env:ZT_DEVICE_ID"
            $headers = @{ "Authorization" = "token $env:ZT_API_TOKEN"; "Content-Type" = "application/json" }
            $body = @{ config = @{ authorized = $false } } | ConvertTo-Json
            try {
              Invoke-RestMethod -Uri $apiUri -Headers $headers -Method Post -Body $body | Out-Null
              Write-Host "âœ… ZeroTierè®¾å¤‡å·²å–æ¶ˆæˆæƒ"
            } catch {
              Write-Warning "âš ï¸ å–æ¶ˆæˆæƒå¤±è´¥ï¼Œéœ€æ‰‹åŠ¨åœ¨ZeroTieræ§åˆ¶å°æ“ä½œ: $apiUri"
            }
          }

      # 11. æ¸…ç†SakuraFrpèµ„æº
      - name: Cleanup SakuraFrp
        shell: pwsh
        if: always()
        run: |
          # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
          Remove-Item -Path "frpc.exe", "start_frp.bat", "frpc.log", "ZeroTierOne.msi" -ErrorAction SilentlyContinue
          Write-Host "âœ… æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†`n"
